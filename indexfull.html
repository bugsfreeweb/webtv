<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bugsfree Studio IPTV</title>    
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        /* ---- Base Styles (sidebar, header, light/dark theme, etc) ---- */
@import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
html, body {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    overflow-x: hidden !important;
}
body {
    font-family: 'VT323', monospace;
    background: #131620;
    color: #D1E7E0;
    font-size: 18px;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    min-width: 100vw;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    display: flex;
    align-items: stretch;
    justify-content: stretch;
    transition: background 0.3s, color 0.3s;
}
body.light {
    background: #f4f8fa;
    color: #252d3b;
}
.tv-container, .tv-screen {
    width: 100vw;
    height: 100vh;
    border-radius: 0;
    overflow: hidden;
    display: flex;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    padding: 0;
    margin: 0;
    z-index: 1;
}
.left-panel {
    width: 240px;
    min-width: 180px;
    max-width: 280px;
    background: rgba(21, 22, 34, 0.97);
    box-shadow: 1px 0 16px 0 rgba(24, 169, 153, 0.04);
    padding: 0;
    display: flex;
    flex-direction: column;
    z-index: 2;
    position: relative;
    overflow-x: hidden !important;
    overflow-y: hidden;
    height: 100vh;
}
body.light .left-panel {
    background: #f7fafc;
    color: #252d3b;
    box-shadow: 1px 0 16px 0 rgba(24, 169, 153, 0.05);
    border-right: 1.5px solid #e0e6ef;
}
.sidebar-tabs {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: stretch;
    padding: 0;
    background: transparent;
    border-bottom: none;
    position: sticky;
    top: 0;
    z-index: 10;
}
.tab-btn {
    background: none;
    border: none;
    flex: 1 1 0;
    padding: 16px 0 11px 0;
    color: #FFD700;
    font-size: 20px;
    cursor: pointer;
    outline: none;
    border-bottom: 2.5px solid transparent;
    transition: background 0.2s, border-bottom 0.2s, color 0.2s, box-shadow 0.3s;
    position: relative;
    z-index: 1;
}
.tab-btn i {
    transition: transform 0.23s cubic-bezier(.2,.79,.63,.99), color 0.23s;
    will-change: transform;
}
.tab-btn:hover, .tab-btn:focus,
.tab-btn.active {
    background: #171b23;
    color: #FFD700;
    border-bottom: 2.5px solid #FFD700;
    box-shadow: 0 2px 12px 0 #18a99933;
}
body.light .tab-btn {
    color: #18A999;
    background: transparent;
}
body.light .tab-btn.active, body.light .tab-btn:hover, body.light .tab-btn:focus {
    background: #ebf3fa;
    color: #FFD700;
    border-bottom: 2.5px solid #FFD700;
}
.tab-content {
    display: none;
    flex-direction: column;
    padding: 16px 14px 6px 14px;
    min-height: 160px;
}
.tab-content.active {
    display: flex;
}
.menu-item {
    padding: 10px 0 8px 0;
    cursor: pointer;
    font-size: 16px;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: color 0.18s;
}
.menu-item:hover {
    color: #FFD700;
}
.sound-control .sound-icon {
    margin-left: 5px;
    display: flex;
    align-items: center;
    border: 2px solid #FFD700;
    border-radius: 50%;
    background: transparent;
    width: 28px;
    height: 28px;
    justify-content: center;
    transition: border-color .2s;
}
body.light .sound-control .sound-icon {
    border-color: #18A999;
}
.sound-control .sound-icon i {
    font-size: 20px;
    pointer-events: none;
    transition: color 0.2s, transform 0.2s;
}
.sound-control .sound-icon.muted {
    border-color: #FF5E5E;
    animation: icon-pulse-red 0.9s cubic-bezier(.2,.79,.63,.99) infinite alternate;
}
@keyframes icon-pulse-red {
    0% { transform: scale(1);}
    100% { transform: scale(1.18); border-color: #FFD700;}
}
.sound-status {
    font-size: 13px;
}
.sound-control .sound-status {
    min-width: 32px;
    text-align: right;
}
#background-sync-btn {
    cursor: pointer;
}
#background-sync-status {
    font-size: 13px;
    min-width: 32px;
    text-align: right;
}
.control-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.sidebar-action-btn {
    background: transparent;
    border: none;
    color: #FFD700;
    font-family: 'VT323', monospace;
    font-size: 15px;
    cursor: pointer;
    outline: none;
    padding: 9px 12px;
    border-radius: 4px;
    margin: 3px 2px 3px 0;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: background 0.25s, color 0.22s, box-shadow .22s;
    position: relative;
    z-index: 1;
    font-weight: bold;
    border: 2px solid transparent;
}
.sidebar-action-btn i {
    transition: transform 0.23s cubic-bezier(.2,.79,.63,.99), color 0.23s;
}
.sidebar-action-btn:hover, .sidebar-action-btn:focus {
    background: #FFD700;
    color: #02dde7;
    box-shadow: 0 2px 8px 0 #FFD70033;
    border-color: #FFD700;
}
body.light .sidebar-action-btn {
    color: #18A999;
    background: #f4f8fa;
    border: 2px solid #18A999;
}
body.light .sidebar-action-btn:hover, body.light .sidebar-action-btn:focus {
    background: #18A999;
    color: #FFD700;
    border-color: #18A999;
}
.icon-bordered {
    border: 2px solid #FFD700 !important;
    background: transparent !important;
}
body.light .icon-bordered {
    border: 2px solid #18A999 !important;
}
input[type="file"], input[type="text"], input[type="url"] {
    font-family: 'VT323', monospace;
    padding: 7px 10px;
    border-radius: 7px;
    border: none;
    background: #20233a;
    color: #FFD700;
    margin: 2px 0 7px 0;
    font-size: 15px;
    width: 100%;
    box-sizing: border-box;
    outline: none;
}
body.light input[type="file"], body.light input[type="text"], body.light input[type="url"] {
    background: #eef4f8;
    color: #18A999;
    border: 1px solid #e0e6ef;
}
input[type="text"]:focus, input[type="url"]:focus {
    outline: 2px solid #FFD700;
}
body.light input[type="text"]:focus, body.light input[type="url"]:focus {
    outline: 2px solid #18A999;
}
form label {
    margin-bottom: 3px;
    color: #FFD700;
    font-size: 14px;
}
body.light form label {
    color: #18A999;
}
form {
    margin-bottom: 8px;
}
.channel-list-box {
    flex: 1 1 0%;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    min-height: 0;
    margin-top: 10px;
    overflow-x: hidden;
}
.channel-list-box h3 {
    color: #FFD700;
    margin: 0;
    padding: 10px 14px 5px 14px;
    font-size: 16px;
    background: transparent;
    text-transform: uppercase;
    position: sticky;
    top: 0;
    z-index: 20;
    border: none;
    letter-spacing: 1px;
    font-weight: 600;
}
body.light .channel-list-box h3 {
    color: #18A999;
}
.channel-list {
    list-style: none;
    margin: 0;
    padding: 0 0 10px 0;
    overflow-y: auto;
    overflow-x: hidden !important;
    flex: 1 1 0%;
}
.channel-list li {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    cursor: pointer;
    border-radius: 5px;
    transition: background 0.2s, color 0.2s, outline 0.18s;
    font-size: 15px;
    outline: none;
}
.channel-list li.active {
    background: rgba(24, 169, 153, 0.18);
    color: #FFD700;
    outline: 2.5px solid #FFD700;
    outline-offset: -2.5px;
}
.channel-list li.running {
    box-shadow: 0 0 0 2.5px #18A999 inset;
}
.channel-list li:hover {
    background: rgba(110, 227, 181, 0.08);
}
.channel-list .playlist-logo {
    width: 32px;
    height: 32px;
    object-fit: contain;
    border-radius: 5px;
    background: #191b27;
    margin-right: 7px;
    box-shadow: 0 2px 8px #18a99933;
    animation: logo-appear 0.6s cubic-bezier(.22,.67,.48,1.41);
}
@keyframes logo-appear {
  from { opacity: 0; transform: scale(0.92);}
  to { opacity: 1; transform: scale(1);}
}
.channel-list .playlist-name {
    flex: 1;
    font-size: 15px;
    word-break: break-word;
}
.channel-list .playlist-fav {
    margin-left: 7px;
    color: #FFD700;
    font-size: 20px;
    cursor: pointer;
    opacity: .5;
    transition: opacity 0.15s;
}
.channel-list .playlist-fav.fav,
.channel-list .playlist-fav:hover {
    opacity: 1;
    filter: drop-shadow(0 2px 10px #FFD70044);
    animation: fav-star-glow 1.2s ease-in-out infinite alternate;
}
@keyframes fav-star-glow {
    0% { filter: drop-shadow(0 2px 10px #FFD70044);}
    100% { filter: drop-shadow(0 2px 18px #FFD700cc);}
}
.sidebar-bottom {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
    background: #171b23;
    padding: 10px 7px 10px 7px;
    position: sticky;
    bottom: 0;
    left: 0;
    right: 0;
    border-top: none;
    z-index: 10;
    min-height: 63px;
}
body.light .sidebar-bottom {
    background: #f4f8fa;
    border-top: 1.5px solid #e0e6ef;
}
.sidebar-bottom button {
    flex: 1 1 0;
    margin: 0 2px;
}
.main-screen {
    flex: 1 1 0%;
    min-width: 0;
    display: flex;
    flex-direction: column;
    background: #191b27;
    position: relative;
    z-index: 1;
    transition: background 0.4s;
}
body.light .main-screen {
    background: #f4f8fa;
}
.tv-header {
    padding: 10px 16px;
    border-bottom: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(17, 20, 32, 0.88);
    box-shadow: 0 2px 12px 0 rgba(24, 169, 153, 0.03);
}
body.light .tv-header {
    background: #f4f8fa;
    box-shadow: 0 2px 12px 0 rgba(24, 169, 153, 0.03);
    border-bottom: 1.5px solid #e0e6ef;
}
.channel-info {
    display: flex;
    gap: 20px;
    align-items: center;
}
.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 22px;
    font-weight: bold;
    color: #FFD700;
    text-shadow: none;
    letter-spacing: 1.5px;
    position: relative;
    z-index: 2;
    overflow-x: hidden;
}
.logo img {
    width: 28px;
    height: 28px;
    filter: brightness(1.2) contrast(1.1);
    border-radius: 4px;
    object-fit: contain;
    margin-right: 2px;
    background: #fff;
    box-shadow: 0 1px 8px #FFD70033, 0 0 0 2px #FFD70022;
    animation: logo-crt-glow 2.2s infinite alternate cubic-bezier(.63,-0.13,.65,1.25);
}
@keyframes logo-crt-glow {
    0% { box-shadow: 0 1px 8px #FFD70022, 0 0 0 3px #FFD70011;}
    100% { box-shadow: 0 1px 20px #FFD70055, 0 0 0 4px #FFD70044;}
}
.header-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}
.header-button {
    background: transparent;
    border: none;
    color: #FFD700;
    padding: 7px 10px;
    font-family: 'VT323', monospace;
    font-size: 18px;
    cursor: pointer;
    transition: color 0.2s, background 0.2s, box-shadow 0.2s;
    border-radius: 4px;
    min-width: 30px;
    display: flex;
    align-items: center;
    position: relative;
    z-index: 1;
    border: 2px solid #FFD700 !important;
}
.header-button i {
    transition: transform 0.23s cubic-bezier(.2,.79,.63,.99), color 0.23s;
    will-change: transform;
}
.header-button:focus, .header-button:hover {
    color: #02dde7;
    background: #FFD700;
    box-shadow: 0 2px 12px #FFD70044;
}
.header-button:hover i, .header-button:focus i {
    transform: scale(1.22) rotate(-8deg);
    color: #23273a !important;
    filter: drop-shadow(0 1px 5px #FFD70066);
}
body.light .header-button, body.light .header-button.icon-bordered {
    border: 2px solid #18A999 !important;
    color: #18A999;
}
body.light .header-button:focus, body.light .header-button:hover {
    background: #18A999;
    color: #FFD700;
}
.time {
    font-size: 20px;
    color: #FFD700;
    letter-spacing: 2px;
}
body.light .time {
    color: #293549;
}
.video-container {
    flex: 1 1 0%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    background: #12151E;
    overflow: hidden;
    min-height: 180px;
}
body.light .video-container {
    background: #e5e8ee;
}
#video-frame {
    width: 100%;
    height: 100%;
    min-width: 100%;
    min-height: 100%;
    background: #000;
    outline: none;
    border: none;
    display: block;
    object-fit: contain;
}
.status-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(17, 20, 32, 0.93);
    padding: 9px 16px;
    border-top: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 100;
    font-size: 15px;
}
body.light .status-bar {
    background: #f4f8fa;
}
.now-playing {
    display: flex;
    align-items: center;
    gap: 12px;
}
.live-indicator {
    background: #FFD700;
    color: #191b27;
    padding: 2px 8px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 12px;
    animation: blink 2s infinite;
}
@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.5; }
}
.viewer-count {
    color: #FFD700;
}
.scanlines {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    background-image: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(24, 169, 153, 0.02) 2px,
        rgba(24, 169, 153, 0.02) 4px
    );
    z-index: 1000;
}
.analysis-summary {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.analysis-list {
    list-style: none;
    margin: 12px 0 0 0;
    padding: 0;
    font-size: 15px;
    width: 100%;
}
.analysis-list li {
    margin: 4px 0;
    display: flex;
    justify-content: center;
    gap: 10px;
}
.analysis-link {
    border: none;
    background: none;
    color: inherit;
    font-family: inherit;
    font-size: inherit;
    padding: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: color 0.16s;
}
.analysis-link:focus, .analysis-link:hover {
    color: #FFD700;
    text-decoration: underline;
}
.history-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-bottom: 12px;
}
.history-list {
    list-style: none;
    padding: 0;
    margin: 0;
    flex: 1 1 0%;
    overflow-y: auto;
    min-height: 60px;
    overflow-x: hidden;
}
.history-list li {
    display: flex;
    align-items: center;
    padding: 8px 0 8px 8px;
    gap: 0;
    position: relative;
}
.history-list .history-name {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.history-list .history-remove, .history-list .history-resync {
    margin-left: 5px;
    color: #FF5E5E;
    font-size: 18px;
    cursor: pointer;
    border: 2px solid #FF5E5E;
    border-radius: 50%;
    background: transparent;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color .18s, color .18s, transform .21s;
    position: relative;
    right: 0;
}
.history-list .history-resync {
    color: #18A999;
    border-color: #18A999;
}
.history-list .history-remove:hover,
.history-list .history-resync:hover {
    color: #FFD700;
    border-color: #FFD700;
    transform: scale(1.13) rotate(-7deg);
}
.favorites-list {
    list-style: none;
    padding: 0;
    margin: 0;
    flex: 1 1 0%;
    overflow-y: auto;
    min-height: 60px;
    overflow-x: hidden;
}
.favorites-list li {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    background: none;
    margin: 2px 0;
    transition: background .18s;
}
.favorites-list li:hover {
    background: rgba(110, 227, 181, 0.08);
}
.favorites-list .playlist-logo {
    width: 36px;
    height: 36px;
    object-fit: contain;
    border-radius: 6px;
    background: #191b27;
    box-shadow: 0 2px 8px #18a99933;
    animation: logo-appear 0.6s cubic-bezier(.22,.67,.48,1.41);
}
.favorites-list .playlist-name {
    flex: 1;
    font-size: 15px;
    word-break: break-word;
}
.favorites-list .fav-remove {
    margin-left: 7px;
    color: #FF5E5E;
    font-size: 20px;
    cursor: pointer;
    border: 2px solid #FF5E5E;
    border-radius: 50%;
    background: transparent;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color .18s, color .18s, transform .18s;
}
.favorites-list .fav-remove:hover {
    color: #FFD700;
    border-color: #FFD700;
    transform: scale(1.14) rotate(10deg);
}
@media (max-width: 1024px) {
    .left-panel {
        width: 43vw;
        min-width: 125px;
        max-width: 280px;
        font-size: 15px;
    }
    .main-screen, .video-container {
        font-size: 15px;
    }
}
@media (max-width: 800px) {
    .left-panel {
        width: 95vw !important;
        max-width: 100vw !important;
        min-width: 140px;
    }
    .sidebar-bottom {
        min-height: 60px;
    }
}
@media (max-width: 768px) {
    .tv-container, .tv-screen {
        flex-direction: column;
    }
    .left-panel {
        width: 100vw !important;
        min-width: 0 !important;
        max-width: 100vw !important;
        border-right: none;
        border-bottom: none;
        font-size: 14px;
        max-height: 67vh;
        overflow-y: auto;
        overflow-x: hidden;
        position: relative;
        height: unset;
    }
    .main-screen {
        flex: 1 1 0%;
    }
    .video-container {
        flex: 1 1 0%;
    }
    .sidebar-bottom {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        margin: 0 auto;
        width: 100vw;
        border-top: 2px solid #FFD700;
        box-shadow: 0 -2px 18px 0 #FFD70033;
        background: #171b23;
    }
    body.light .sidebar-bottom {
        background: #f4f8fa;
        border-top: 2px solid #18A999;
    }
    .tab-content {
        padding-bottom: 78px;
    }
    .channel-list-box {
        padding-bottom: 78px;
    }
}
@media (max-width: 600px), (max-height: 420px) {
    .tv-header {
        padding: 7px 4px;
    }
    .status-bar {
        padding: 6px 4px;
    }
    .channel-list-box h3 {
        font-size: 15px;
    }
    .logo img {
        width: 20px;
        height: 20px;
    }
    .sidebar-bottom {
        min-height: 54px !important;
    }
}

/* --- Extra Effects for Bugsfree Studio Logo (NO inline CSS, just here) --- */
.logo .special-animated {
    position: relative;
    display: inline-block;
    background: linear-gradient(92deg, #FFD700 10%, #18A999 60%, #FFD700 90%);
    background-size: 200% 100%;
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: bold;
    letter-spacing: 2.5px;
    white-space: nowrap;
    text-shadow: 0 1px 8px #FFD70044, 0 0 5px #18A99944;
}
.logo .special-animated.bfs-intro-anim {
    animation:
        bfs-letter-popin 0.8s both,
        bugsfree-studio-glow 3.2s 0.7s linear infinite,
        bugsfree-studio-move 7.5s 0.7s ease-in-out infinite alternate,
        bugsfree-studio-scan 2.5s 0.7s infinite linear;
}
.logo .special-animated.bfs-glow-anim {
    animation:
        bugsfree-studio-glow 3.2s linear infinite,
        bugsfree-studio-move 7.5s ease-in-out infinite alternate,
        bugsfree-studio-scan 2.5s infinite linear;
}
.logo .special-animated.bfs-pulse-anim {
    animation:
        bugsfree-studio-glow 3.2s linear infinite,
        bugsfree-studio-move 7.5s ease-in-out infinite alternate,
        bugsfree-studio-pulse 0.65s 1,
        bugsfree-studio-scan 2.5s infinite linear;
}
.logo .special-animated.bfs-shine-anim {
    animation:
        bugsfree-studio-glow 3.2s linear infinite,
        bugsfree-studio-move 7.5s ease-in-out infinite alternate,
        bugsfree-studio-scan 2.5s infinite linear,
        bugsfree-studio-shine 1.3s 1;
}
.logo .special-animated.bfs-jump-anim {
    animation:
        bugsfree-studio-glow 3.2s linear infinite,
        bugsfree-studio-move 7.5s ease-in-out infinite alternate,
        bugsfree-studio-scan 2.5s infinite linear,
        bugsfree-studio-jump 0.6s 1;
}
@keyframes bfs-letter-popin {
    0% {
        opacity: 0;
        letter-spacing: 1.5em;
        filter: blur(8px) brightness(2.5) drop-shadow(0 0 12px #FFD70099);
        transform: scale(1.2) skewX(-23deg);
    }
    40% {
        opacity: 1;
        letter-spacing: 1.5em;
        filter: blur(3.2px) brightness(1.7) drop-shadow(0 0 18px #FFD700cc);
    }
    70% {
        letter-spacing: 0.15em;
        filter: blur(1.5px) brightness(1.2);
        transform: scale(1.04) skewX(-3deg);
    }
    100% {
        opacity: 1;
        letter-spacing: 2.5px;
        filter: blur(0px) brightness(1) drop-shadow(0 1.5px 6px #18A99966) drop-shadow(0 2px 16px #FFD70055);
        transform: scale(1) skewX(0deg);
    }
}
@keyframes bugsfree-studio-glow {
    0% { filter: drop-shadow(0 1.5px 6px #18A99966) drop-shadow(0 2px 16px #FFD70055);}
    100% { filter: drop-shadow(0 2.5px 12px #18A999aa) drop-shadow(0 3px 28px #FFD700aa);}
}
@keyframes bugsfree-studio-move {
    0% { background-position: 0% 50%;}
    100% { background-position: 100% 50%;}
}
@keyframes bugsfree-studio-scan {
    0%,100% { text-shadow: 0 1px 8px #FFD70044, 0 0 5px #18A99944; }
    8% { text-shadow: 0 2px 16px #FFD700, 0 0 10px #18A99977; }
    12% { text-shadow: 0 2px 24px #FFD70099, 0 0 15px #18A999bb; }
    14% { text-shadow: 0 2px 28px #FFD700aa, 0 0 21px #18A999cc;}
    16% { text-shadow: 0 1px 8px #FFD70044, 0 0 5px #18A99944;}
}
@keyframes bugsfree-studio-pulse {
    0% { transform: scale(1) skewX(0deg); text-shadow: 0 1px 8px #FFD70044, 0 0 5px #18A99944;}
    50% { transform: scale(1.10) skewX(3deg); text-shadow: 0 2px 22px #FFD700cc, 0 0 12px #18A999bb;}
    100% { transform: scale(1) skewX(0deg); }
}
.logo .special-animated.bfs-shine-anim:before {
    content: '';
    position: absolute;
    top: 0; left: -30%; width: 40%; height: 100%;
    background: linear-gradient(120deg,rgba(255,255,255,0) 0%,rgba(255,255,255,0.7) 30%,rgba(255,255,255,0) 80%);
    pointer-events: none;
    z-index: 1;
    animation: bugsfree-studio-shine-bar 1.3s;
}
@keyframes bugsfree-studio-shine-bar {
    0% { left: -30%; opacity:0; }
    15% { opacity:1; }
    60% { left: 100%; opacity:1;}
    100% { left: 110%; opacity:0;}
}
@keyframes bugsfree-studio-jump {
    0% { transform: translateY(0);}
    20% { transform: translateY(-10px) scale(1.08);}
    40% { transform: translateY(-18px) scale(1.12);}
    60% { transform: translateY(-8px) scale(1.06);}
    100% { transform: translateY(0);}
}
    </style>
</head>
<body>
    <div class="tv-container">
        <div class="tv-screen">
            <aside class="left-panel">
                <nav class="sidebar-tabs">
                    <button class="tab-btn active" data-tab="upload" title="Upload"><i data-feather="upload"></i></button>
                    <button class="tab-btn" data-tab="settings" title="Settings"><i data-feather="settings"></i></button>
                    <button class="tab-btn" data-tab="history" title="History"><i data-feather="clock"></i></button>
                    <button class="tab-btn" data-tab="favorites" title="Favorites"><i data-feather="star"></i></button>
                    <button class="tab-btn" data-tab="analysis" title="Analysis"><i data-feather="pie-chart"></i></button>
                </nav>
                <section class="tab-content tab-upload active">
                    <form id="m3u-upload-form" enctype="multipart/form-data" autocomplete="off">
                        <label>Upload m3u/json/txt:</label>
                        <input type="file" id="m3u-file-input" accept=".m3u,.m3u8,.json,.txt,.list,.channels">
                    </form>
                    <form id="m3u-url-form" autocomplete="off">
                        <label>Load playlist by URL:</label>
                        <input type="url" id="m3u-url-input" placeholder="Paste m3u/m3u8/json/txt URL...">
                        <button type="submit" class="sidebar-action-btn"><i data-feather="link"></i> Load</button>
                    </form>
                    <form id="single-channel-form" autocomplete="off">
                        <label>Add Single Channel:</label>
                        <input type="text" id="single-channel-url" placeholder="Channel Stream URL">
                        <input type="text" id="single-channel-name" placeholder="Channel Name (optional)">
                        <input type="text" id="single-channel-logo" placeholder="Logo URL (optional)">
                        <button type="submit" class="sidebar-action-btn"><i data-feather="plus-circle"></i> Add</button>
                    </form>
                </section>
                <section class="tab-content tab-settings">
                    <div class="menu-item sound-control" id="mute-btn">
                        <span>Sound</span>
                        <span class="sound-status" id="sound-status">ON</span>
                        <span class="sound-icon" id="sound-icon-btn"><i data-feather="volume-2"></i></span>
                    </div>
                    <div class="menu-item control-item" id="scanlines-btn">
                        <span>Scanlines</span>
                        <span class="control-status" id="scanlines-status">ON</span>
                    </div>
                    <div class="menu-item control-item" id="background-sync-btn">
                        <span>Background Sync</span>
                        <span class="control-status" id="background-sync-status">OFF</span>
                    </div>
                    <div class="menu-item control-item">
                        <span>Brightness</span>
                        <input type="range" class="control-slider" id="brightness-slider" min="50" max="150" value="100">
                    </div>
                    <div class="menu-item control-item">
                        <span>Contrast</span>
                        <input type="range" class="control-slider" id="contrast-slider" min="50" max="200" value="100">
                    </div>
                    <div class="menu-item control-item">
                        <span>Saturation</span>
                        <input type="range" class="control-slider" id="saturation-slider" min="0" max="200" value="100">
                    </div>
                </section>
                <section class="tab-content tab-history">
                    <div class="history-actions">
                        <button id="history-delete-all" class="sidebar-action-btn"><i data-feather="trash-2"></i> Delete All</button>
                        <button id="history-resync-all" class="sidebar-action-btn"><i data-feather="refresh-ccw"></i> Resync All</button>
                    </div>
                    <ul class="history-list" id="history-list"></ul>
                </section>
                <section class="tab-content tab-favorites">
                    <ul class="favorites-list" id="favorites-list"></ul>
                </section>
                <section class="tab-content tab-analysis">
                    <div class="analysis-summary">
                        <canvas id="analysis-chart" width="180" height="180"></canvas>
                        <ul class="analysis-list">
                            <li><button type="button" class="analysis-link" id="analysis-total-btn"><span>Total Channels:</span> <span id="analysis-total">0</span></button></li>
                            <li><button type="button" class="analysis-link" id="analysis-online-btn"><span>Online:</span> <span id="analysis-online">0</span></button></li>
                            <li><button type="button" class="analysis-link" id="analysis-offline-btn"><span>Offline:</span> <span id="analysis-offline">0</span></button></li>
                        </ul>
                        <button type="button" id="analysis-sync-btn" class="sidebar-action-btn"><i data-feather="refresh-cw"></i> Sync Channels</button>
                    </div>
                </section>
                <div class="channel-list-box">
                    <h3>PLAYLIST</h3>
                    <ul class="channel-list" id="channel-list"></ul>
                </div>
                <div class="sidebar-bottom">
                    <button id="theme-toggle" class="sidebar-action-btn icon-bordered" title="Toggle Theme">
                        <i data-feather="sun"></i>
                    </button>
                    <button class="sidebar-action-btn icon-bordered" id="report-issue-btn" title="Report Issue">
                        <i data-feather="alert-circle"></i>
                    </button>
                    <button class="sidebar-action-btn icon-bordered" id="sidebar-exit-btn" title="Hide Sidebar">
                        <i data-feather="chevrons-left"></i>
                    </button>
                </div>
            </aside>
            <main class="main-screen">
                <div class="tv-header">
                    <div class="channel-info">
                        <div class="logo">
                            <img id="channel-logo" src="https://bugsfreecdn.netlify.app/BugsfreeDefault/logo.png" alt="Channel Logo" onerror="this.src='https://bugsfreecdn.netlify.app/BugsfreeDefault/logo.png'">
                            <span class="special-animated">Bugsfree Studio</span>
                        </div>
                        <div>CH <span id="current-channel">01</span></div>
                    </div>
                    <div class="header-controls">
                        <button class="header-button icon-bordered" id="main-mute-btn" title="Toggle Sound"><i data-feather="volume-2"></i></button>
                        <button class="header-button icon-bordered" id="next-channel-btn" title="Next Channel"><i data-feather="skip-forward"></i></button>
                        <button class="header-button icon-bordered" id="sidebar-toggle-btn" title="Show/Hide Sidebar"><i data-feather="menu"></i></button>
                    </div>
                    <div class="time" id="current-time">--:--:--</div>
                </div>
                <div class="video-container" id="video-container"></div>
                <div class="status-bar">
                    <div class="now-playing">
                        <div class="live-indicator">LIVE</div>
                        <div id="channel-name">No Channel</div>
                    </div>
                    <div class="viewer-count">
                        <span id="viewer-count">0</span> watching
                    </div>
                </div>
            </main>
            <div class="scanlines"></div>
        </div>
    </div>    
    <script>
    // Bugsfree Studio IPTV - including animated Bugsfree Studio logo effect cycles

function $(q) { return document.querySelector(q); }
function $all(q) { return Array.from(document.querySelectorAll(q)); }
const DEFAULT_LOGO = 'https://bugsfreecdn.netlify.app/BugsfreeDefault/logo.png';
const PLAYER_POSTER = 'https://bugsfreecdn.netlify.app/BugsfreeDefault/player-poster.webp';

let currentChannelIndex = 0;
let isMuted = false;
let viewerCount = 0;
let scanlinesEnabled = true;
let currentBrightness = 100;
let currentContrast = 100;
let currentSaturation = 100;
let theme = localStorage.getItem('theme') || 'dark';
let playlistKey = "iptv_channels";
let playlistLoaded = false;

const demoPlaylist = [
    {
        src: "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8",
        name: "Demo HLS Stream",
        number: "01",
        type: "hls",
        logo: DEFAULT_LOGO,
        favorite: false
    }
];

let channels = [];
let filteredChannels = [];
let history = JSON.parse(localStorage.getItem('iptv_history') || "[]");
let favorites = JSON.parse(localStorage.getItem('iptv_favorites') || "[]");

// Background Sync State
let backgroundSyncEnabled = false;
let backgroundSyncInterval = null;
let lastOnlineChannels = [];
let syncInProgress = false;

// ---- Helpers ----
function saveChannelsToStorage() {
    if (playlistLoaded) localStorage.setItem(playlistKey, JSON.stringify(channels));
    else localStorage.removeItem(playlistKey);
}
function loadChannelsFromStorage() {
    const stored = localStorage.getItem(playlistKey);
    if (stored) {
        try {
            channels = JSON.parse(stored);
            playlistLoaded = true;
        } catch (e) {
            channels = [];
            playlistLoaded = false;
        }
    } else {
        channels = [];
        playlistLoaded = false;
    }
}
function getStreamType(url) {
    if (!url) return "hls";
    if (url.endsWith('.m3u8')) return 'hls';
    if (url.endsWith('.mpd')) return 'dash';
    if (url.endsWith('.mp4')) return 'mp4';
    if (url.endsWith('.ts')) return 'ts';
    if (/\.mp4(\?|$)/.test(url)) return 'mp4';
    if (/\.ts(\?|$)/.test(url)) return 'ts';
    if (/\.m3u8(\?|$)/.test(url)) return 'hls';
    if (/\.mpd(\?|$)/.test(url)) return 'dash';
    return 'hls';
}
function getChannelLogo(ch) {
    return ch.logo ? ch.logo : DEFAULT_LOGO;
}
function setChannelLogo(ch) {
    $('#channel-logo').src = getChannelLogo(ch);
}
function saveHistory() {
    localStorage.setItem('iptv_history', JSON.stringify(history));
}
function saveFavorites() {
    localStorage.setItem('iptv_favorites', JSON.stringify(favorites));
}
function updateFavoritesListUI() {
    const list = $('#favorites-list');
    list.innerHTML = '';
    favorites.forEach((ch, i) => {
        const li = document.createElement('li');
        li.innerHTML = `<img src="${getChannelLogo(ch)}" class="playlist-logo" onerror="this.src='${DEFAULT_LOGO}'">
            <span class="playlist-name">${ch.name}</span>
            <button class="fav-remove" title="Unfavorite" data-index="${i}"><i data-feather="x"></i></button>`;
        li.querySelector('.fav-remove').onclick = e => {
            e.stopPropagation();
            favorites.splice(i, 1);
            saveFavorites();
            updateFavoritesListUI();
            renderChannelList();
        };
        list.appendChild(li);
    });
    feather.replace();
}
function updateHistoryListUI() {
    const list = $('#history-list');
    list.innerHTML = '';
    history.forEach((h, i) => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="history-name">${h.name || h.file || h.url}</span>
            <button class="history-resync" title="Resync" data-index="${i}"><i data-feather="refresh-ccw"></i></button>
            <button class="history-remove" title="Delete" data-index="${i}"><i data-feather="trash-2"></i></button>`;
        li.querySelector('.history-remove').onclick = () => {
            history.splice(i, 1);
            saveHistory();
            updateHistoryListUI();
        };
        li.querySelector('.history-resync').onclick = () => {
            if (h.type === 'file') handleFileReload(h.fileContent, h.file, true);
            else if (h.type === 'url') handleUrlReload(h.url, true);
        };
        list.appendChild(li);
    });
    feather.replace();
}
$('#history-delete-all').onclick = function() {
    history = [];
    saveHistory();
    updateHistoryListUI();
    channels = [];
    filteredChannels = [];
    playlistLoaded = false;
    lastOnlineChannels = [];
    saveChannelsToStorage();
    stopBackgroundSync();
    renderChannelList();
    playChannel(0, demoPlaylist);
};
$('#history-resync-all').onclick = function() {
    history.forEach(h => {
        if (h.type === 'file') handleFileReload(h.fileContent, h.file, true);
        else if (h.type === 'url') handleUrlReload(h.url, true);
    });
};

// ---- Background Sync Logic ----
function startBackgroundSync() {
    if (backgroundSyncInterval) clearInterval(backgroundSyncInterval);
    backgroundSyncEnabled = true;
    $('#background-sync-status').textContent = "ON";
    syncAndShowOnlineChannels();
    backgroundSyncInterval = setInterval(syncAndShowOnlineChannels, 120000); // every 2 min
}
function stopBackgroundSync() {
    backgroundSyncEnabled = false;
    $('#background-sync-status').textContent = "OFF";
    if (backgroundSyncInterval) clearInterval(backgroundSyncInterval);
    lastOnlineChannels = [];
    renderChannelList();
}
async function syncAndShowOnlineChannels() {
    if (syncInProgress) return;
    syncInProgress = true;
    let pl = playlistLoaded ? channels : demoPlaylist;
    let online = [];
    for (let ch of pl) {
        try {
            await Promise.race([
                fetch(ch.src, { method: 'HEAD', mode: 'no-cors' }),
                new Promise((_, rej) => setTimeout(rej, 2000))
            ]);
            online.push(ch);
        } catch (e) { /* offline */ }
    }
    lastOnlineChannels = online;
    renderChannelList(online);
    syncInProgress = false;
}
$('#background-sync-btn').onclick = function () {
    if (!backgroundSyncEnabled) startBackgroundSync();
    else stopBackgroundSync();
};

// ---- Channel List Rendering ----
function renderChannelList(list = null) {
    const channelList = $('#channel-list');
    let pl = (list || (backgroundSyncEnabled ? lastOnlineChannels : (filteredChannels.length ? filteredChannels : (playlistLoaded ? channels : demoPlaylist))));
    channelList.innerHTML = '';
    pl.forEach((ch, i) => {
        let running = (i === currentChannelIndex && !filteredChannels.length);
        const li = document.createElement('li');
        let favClass = (favorites.find(f => f.src === ch.src)) ? 'fav' : '';
        li.className = ((i === currentChannelIndex && !filteredChannels.length) ? 'active running' : (i === currentChannelIndex ? 'active' : ''));
        li.innerHTML = `<img src="${getChannelLogo(ch)}" class="playlist-logo" onerror="this.src='${DEFAULT_LOGO}'">
                        <span class="playlist-name">${ch.name}</span>
                        <span class="playlist-fav ${favClass}" title="Favorite"><i data-feather="star"></i></span>`;
        li.addEventListener('click', e => {
            if (e.target.closest('.playlist-fav')) {
                if (!favorites.find(f => f.src === ch.src)) {
                    favorites.push(ch);
                } else {
                    favorites = favorites.filter(f => f.src !== ch.src);
                }
                saveFavorites();
                renderChannelList();
                updateFavoritesListUI();
            } else {
                currentChannelIndex = i;
                playChannel(i, pl);
            }
        });
        channelList.appendChild(li);
    });
    feather.replace();
}

// ---- Playback ----
function getPlayerHtml(channel, muted) {
    return `<video id="video-frame" controls autoplay playsinline style="width:100%;height:100%;background:#000;" poster="${PLAYER_POSTER}" ${muted?'muted':''}></video>`;
}
function playChannel(index, showChannels = null) {
    let pl = (showChannels || (backgroundSyncEnabled ? lastOnlineChannels : (filteredChannels.length ? filteredChannels : (playlistLoaded ? channels : demoPlaylist))));
    if (index < 0 || index >= pl.length) return;
    currentChannelIndex = index;
    const channel = pl[index];
    const container = $('#video-container');
    container.innerHTML = getPlayerHtml(channel, isMuted);
    // Animated Bugsfree Studio logo
    const logoDiv = document.querySelector('.logo');
    if (logoDiv) {
        logoDiv.innerHTML = `<img id="channel-logo" src="${getChannelLogo(channel)}" alt="Channel Logo" onerror="this.src='${DEFAULT_LOGO}'">
        <span class="special-animated">Bugsfree Studio</span>`;
    }
    setChannelLogo(channel);

    const video = $('#video-frame');
    const src = channel.src;
    if (!video) return;
    if (channel.type === 'hls' || channel.type === 'ts') {
        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(src);
            hls.attachMedia(video);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = src;
        } else {
            video.src = src;
        }
    } else if (channel.type === 'mp4' || channel.type === 'dash') {
        video.src = src;
    } else {
        video.src = src;
    }
    video.muted = isMuted;
    video.volume = isMuted ? 0 : 1;
    document.getElementById('current-channel').textContent = channel.number;
    document.getElementById('channel-name').textContent = channel.name;
    updateMuteIcons();
    renderChannelList(pl);
    // re-apply Bugsfree Studio logo animation (since logo is re-rendered)
    addBugsfreeStudioLogoAnimation();
}
function updateMuteIcons() {
    let icon = isMuted ? "volume-x" : "volume-2";
    $all("#main-mute-btn i, #sound-icon-btn i").forEach(el=>{
        el.setAttribute("data-feather", icon);
    });
    $('#sound-status').textContent = isMuted ? 'OFF' : 'ON';
    let iconDiv = $('#sound-icon-btn');
    if (isMuted) iconDiv && iconDiv.classList.add('muted');
    else iconDiv && iconDiv.classList.remove('muted');
    feather.replace();
}
function playByChannel(ch) {
    let pl = backgroundSyncEnabled ? lastOnlineChannels : (playlistLoaded ? channels : demoPlaylist);
    let idx = pl.findIndex(c => c.src === ch.src);
    if (idx >= 0) {
        currentChannelIndex = idx;
        playChannel(idx, pl);
    }
}
function nextChannel() {
    let pl = backgroundSyncEnabled ? lastOnlineChannels : (filteredChannels.length ? filteredChannels : (playlistLoaded ? channels : demoPlaylist));
    currentChannelIndex = (currentChannelIndex + 1) % pl.length;
    playChannel(currentChannelIndex, pl);
}
function prevChannel() {
    let pl = backgroundSyncEnabled ? lastOnlineChannels : (filteredChannels.length ? filteredChannels : (playlistLoaded ? channels : demoPlaylist));
    currentChannelIndex = (currentChannelIndex - 1 + pl.length) % pl.length;
    playChannel(currentChannelIndex, pl);
}
function toggleMute() {
    isMuted = !isMuted;
    let pl = backgroundSyncEnabled ? lastOnlineChannels : (filteredChannels.length ? filteredChannels : (playlistLoaded ? channels : demoPlaylist));
    playChannel(currentChannelIndex, pl);
}
function toggleScanlines() {
    scanlinesEnabled = !scanlinesEnabled;
    const scanlines = $('.scanlines');
    const status = $('#scanlines-status');
    scanlines.style.display = scanlinesEnabled ? 'block' : 'none';
    status.textContent = scanlinesEnabled ? 'ON' : 'OFF';
}
function adjustBrightness(val) { currentBrightness = val; updateVideoFilters(); }
function adjustContrast(val) { currentContrast = val; updateVideoFilters(); }
function adjustSaturation(val) { currentSaturation = val; updateVideoFilters(); }
function updateVideoFilters() {
    const videoContainer = $('.video-container');
    videoContainer.style.filter = `brightness(${currentBrightness/100}) contrast(${currentContrast/100}) saturate(${currentSaturation/100})`;
}

// ---- Playlist File Parsing ----
function parseJson(content) {
    let arr = [];
    try {
        const data = JSON.parse(content);
        let chNum = 1;
        let channelsArr = [];
        if (Array.isArray(data)) {
            channelsArr = data;
        } else if (typeof data === 'object' && Array.isArray(data.channels)) {
            channelsArr = data.channels;
        } else if (typeof data === 'object' && typeof data.channels === 'object' && data.channels !== null) {
            for (let group in data.channels) {
                if (Array.isArray(data.channels[group])) {
                    data.channels[group].forEach(ch => channelsArr.push(ch));
                }
            }
        }
        channelsArr.forEach(ch => {
            let url = ch.src || ch.url;
            if (!url) return;
            arr.push({
                src: url,
                name: ch.name || `JSON Channel ${chNum}`,
                number: ch.number || String(chNum).padStart(2, '0'),
                type: ch.type || getStreamType(url),
                logo: ch.logo || DEFAULT_LOGO,
                favorite: false
            });
            chNum++;
        });
    } catch (e) { }
    return arr;
}
function parseM3u(content) {
    const lines = content.split('\n');
    let out = [];
    let lastInf = null;
    let chNum = 1;
    for(let i=0; i<lines.length; ++i) {
        let l = lines[i].trim();
        if (l.startsWith('#EXTINF')) {
            lastInf = l;
        } else if (l && !l.startsWith('#')) {
            let nameMatch = /,(.+)$/.exec(lastInf || '');
            let logoMatch = /tvg-logo="([^"]+)"/.exec(lastInf || '');
            let name = nameMatch ? nameMatch[1].trim() : `M3U Channel ${chNum}`;
            let url = l;
            let type = getStreamType(url);
            let logo = logoMatch ? logoMatch[1] : DEFAULT_LOGO;
            out.push({
                type,
                src: url,
                name,
                number: String(chNum).padStart(2, '0'),
                logo,
                favorite: false
            });
            chNum++;
            lastInf = null;
        }
    }
    return out;
}
function parseTxt(content) {
    let arr = [];
    let chNum = 1;
    content.split('\n').forEach(line => {
        let l = line.trim();
        if (!l || l.startsWith('#')) return;
        let [url, name] = l.split('|');
        url = url.trim();
        let type = getStreamType(url);
        arr.push({
            src: url,
            name: name ? name.trim() : `TXT Channel ${chNum}`,
            number: String(chNum).padStart(2, '0'),
            type,
            logo: DEFAULT_LOGO,
            favorite: false
        });
        chNum++;
    });
    return arr;
}
function parseCustom(content) {
    let arr = parseTxt(content);
    if (!arr.length) arr = parseM3u(content);
    return arr;
}
function handleFileReload(content, file, historyOnly) {
    let chs = [];
    if (file.endsWith('.json')) chs = parseJson(content);
    else if (file.endsWith('.txt')) chs = parseTxt(content);
    else if (file.endsWith('.m3u') || file.endsWith('.m3u8')) chs = parseM3u(content);
    else chs = parseCustom(content);
    if (chs.length && !historyOnly) {
        channels = chs;
        playlistLoaded = true;
        filteredChannels = [];
        saveChannelsToStorage();
        renderChannelList();
        playChannel(0, channels);
    }
}
function handleUrlReload(url, historyOnly) {
    fetch(url)
        .then(res => res.text())
        .then(txt => {
            let chs = [];
            if (url.endsWith('.json')) chs = parseJson(txt);
            else if (url.endsWith('.txt')) chs = parseTxt(txt);
            else if (url.endsWith('.m3u') || url.endsWith('.m3u8')) chs = parseM3u(txt);
            else chs = parseCustom(txt);
            if (chs.length && !historyOnly) {
                channels = chs;
                playlistLoaded = true;
                filteredChannels = [];
                saveChannelsToStorage();
                renderChannelList();
                playChannel(0, channels);
            }
        });
}

// ---- Upload Events ----
$('#m3u-file-input').addEventListener('change', function(evt) {
    const file = evt.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        let chs = [];
        const lowName = file.name.toLowerCase();
        if (lowName.endsWith('.json')) {
            chs = parseJson(e.target.result);
        } else if (lowName.endsWith('.txt')) {
            chs = parseTxt(e.target.result);
        } else if (lowName.endsWith('.m3u') || lowName.endsWith('.m3u8')) {
            chs = parseM3u(e.target.result);
        } else {
            chs = parseCustom(e.target.result);
        }
        if (chs.length) {
            channels = chs;
            playlistLoaded = true;
            filteredChannels = [];
            saveChannelsToStorage();
            renderChannelList();
            playChannel(0, channels);
            history.push({type:'file', name:file.name, file:file.name, fileContent:e.target.result, time:Date.now()});
            saveHistory();
            updateHistoryListUI();
            $('#m3u-upload-form').style.display = "none";
            $('#m3u-url-form').style.display = "none";
        } else {
            alert('No valid channels found in uploaded file.');
        }
        evt.target.value = '';
    };
    reader.readAsText(file);
});
$('#m3u-upload-form').addEventListener('submit', function(evt) {
    evt.preventDefault();
});
$('#m3u-url-form').addEventListener('submit', function(evt) {
    evt.preventDefault();
    const url = $('#m3u-url-input').value.trim();
    if (!url) return;
    fetch(url)
        .then(res => res.text())
        .then(txt => {
            let chs = [];
            const lurl = url.toLowerCase();
            if (lurl.endsWith('.json')) chs = parseJson(txt);
            else if (lurl.endsWith('.txt')) chs = parseTxt(txt);
            else if (lurl.endsWith('.m3u') || lurl.endsWith('.m3u8')) chs = parseM3u(txt);
            else chs = parseCustom(txt);
            if(chs.length) {
                channels = chs;
                playlistLoaded = true;
                filteredChannels = [];
                saveChannelsToStorage();
                renderChannelList();
                playChannel(0, channels);
                history.push({type:'url', name:url.split('/').pop(), url, time:Date.now()});
                saveHistory();
                updateHistoryListUI();
                $('#m3u-upload-form').style.display = "none";
                $('#m3u-url-form').style.display = "none";
            } else {
                alert('No valid channels found in the playlist URL.');
            }
        })
        .catch(() => alert('Failed to load playlist from URL.'));
});
$('#single-channel-form').addEventListener('submit', function(evt) {
    evt.preventDefault();
    const url = $('#single-channel-url').value.trim();
    const name = $('#single-channel-name').value.trim();
    const logo = $('#single-channel-logo').value.trim() || DEFAULT_LOGO;
    if (!url) return;
    let type = getStreamType(url);
    let ch = {
        type,
        src: url,
        name: name || `Channel ${channels.length+1}`,
        number: String(channels.length+1).padStart(2, '0'),
        logo,
        favorite: false
    };
    if (!playlistLoaded) {
        channels = [ch];
        playlistLoaded = true;
    } else {
        channels.push(ch);
    }
    filteredChannels = [];
    saveChannelsToStorage();
    renderChannelList();
    playChannel(0, channels);
    $('#single-channel-url').value = '';
    $('#single-channel-name').value = '';
    $('#single-channel-logo').value = '';
});

// ---- Tabs ----
$all('.tab-btn').forEach(btn => {
    btn.onclick = function() {
        $all('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        let tab = btn.getAttribute('data-tab');
        $all('.tab-content').forEach(sec => {
            sec.classList.toggle('active', sec.classList.contains('tab-'+tab));
        });
        if(tab === "upload") {
            $('#m3u-upload-form').style.display = "";
            $('#m3u-url-form').style.display = "";
        }
    }
});

// ---- Settings ----
$('#theme-toggle').onclick = function() {
    theme = (theme === 'dark') ? 'light' : 'dark';
    document.body.classList.toggle('light', theme === 'light');
    localStorage.setItem('theme', theme);
    updateThemeIcon();
};
function updateThemeIcon() {
    let iconEl = $('#theme-toggle i');
    if (iconEl) {
        iconEl.setAttribute('data-feather', theme === 'light' ? 'moon' : 'sun');
        feather.replace();
    }
}
$('#report-issue-btn').onclick = function() {
    window.open('https://github.com/bugsfreeweb/jhand.tv/issues', '_blank');
};
$('#sidebar-exit-btn').onclick = function() {
    $('.left-panel').style.display = 'none';
};
function toggleSidebar() {
    const sidebar = $('.left-panel');
    sidebar.style.display = (sidebar.style.display === 'none') ? 'flex' : 'none';
}
$('#mute-btn').onclick = toggleMute;
$('#main-mute-btn').onclick = toggleMute;
$('#scanlines-btn').onclick = toggleScanlines;
$('#brightness-slider').oninput = e => adjustBrightness(e.target.value);
$('#contrast-slider').oninput = e => adjustContrast(e.target.value);
$('#saturation-slider').oninput = e => adjustSaturation(e.target.value);

// Attach JS click handlers for header buttons (no inline JS)
const nextBtn = document.getElementById('next-channel-btn');
if(nextBtn) nextBtn.onclick = nextChannel;
const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
if(sidebarToggleBtn) sidebarToggleBtn.onclick = toggleSidebar;

// ---- Keyboard & Gesture ----
document.addEventListener('keydown', (e) => {
    if (document.activeElement.tagName === "INPUT") return;
    switch(e.key) {
        case 'ArrowUp':
            prevChannel();
            break;
        case 'ArrowDown':
            nextChannel();
            break;
        case 'ArrowLeft':
            adjustVolume(-0.05);
            break;
        case 'ArrowRight':
            adjustVolume(0.05);
            break;
        case ' ':
            e.preventDefault();
            toggleMute();
            break;
        case 'Enter':
            nextChannel();
            break;
        case 'Escape':
            toggleSidebar();
            break;
    }
});
function adjustVolume(diff) {
    const video = $('#video-frame');
    if (video) {
        let v = video.volume + diff;
        v = Math.max(0, Math.min(1, v));
        video.volume = v;
        isMuted = (v === 0);
        updateMuteIcons();
    }
}
let touchStartX = 0, touchStartY = 0, touchEndX = 0, touchEndY = 0;
function handleGesture() {
    let dx = touchEndX - touchStartX;
    let dy = touchEndY - touchStartY;
    if (Math.abs(dx) > Math.abs(dy)) {
        if (dx > 50) prevChannel();
        else if (dx < -50) nextChannel();
    } else {
        const video = $('#video-frame');
        if (!video) return;
        if (dy < -30) adjustVolume(0.1);
        else if (dy > 30) adjustVolume(-0.1);
    }
}
document.addEventListener('touchstart', function(e){
    if (e.touches.length !== 1) return;
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
}, {passive:true});
document.addEventListener('touchend', function(e){
    if (e.changedTouches.length !== 1) return;
    touchEndX = e.changedTouches[0].clientX;
    touchEndY = e.changedTouches[0].clientY;
    handleGesture();
}, {passive:true});

// ---- UI: Time, Viewer, Analysis ----
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: true 
    });
    $('#current-time').textContent = timeString;
}
function updateViewerCount() {
    viewerCount = Math.floor(Math.random() * 100) + 1;
    $('#viewer-count').textContent = viewerCount;
}
let analysisChart = null;
let lastAnalysis = { online: [], offline: [] };
function updateAnalysis(sync = false) {
    let pl = playlistLoaded ? channels : demoPlaylist;
    const total = pl.length;
    let online = [];
    let offline = [];
    if (total === 0) {
        $('#analysis-total').textContent = "0";
        $('#analysis-online').textContent = "0";
        $('#analysis-offline').textContent = "0";
        if (analysisChart) {
            analysisChart.data.datasets[0].data = [0, 0];
            analysisChart.update();
        }
        return;
    }
    if (!sync && lastAnalysis.online.length + lastAnalysis.offline.length === total) {
        online = lastAnalysis.online;
        offline = lastAnalysis.offline;
    } else {
        online = [];
        offline = [];
        let checked = 0;
        $('#analysis-total').textContent = total;
        $('#analysis-online').textContent = "Checking...";
        $('#analysis-offline').textContent = "Checking...";
        pl.forEach((ch, i) => {
            let timeout = setTimeout(() => {
                offline.push(ch);
                checked++;
                updateA();
            }, 2000);
            fetch(ch.src, { method: 'HEAD', mode:"no-cors" }).then(()=> {
                clearTimeout(timeout);
                online.push(ch);
                checked++;
                updateA();
            }).catch(()=> {
                clearTimeout(timeout);
                offline.push(ch);
                checked++;
                updateA();
            });
        });
        function updateA() {
            $('#analysis-online').textContent = online.length;
            $('#analysis-offline').textContent = offline.length;
            if (checked === total) {
                lastAnalysis = { online, offline };
                if (analysisChart) {
                    analysisChart.data.datasets[0].data = [online.length, offline.length];
                    analysisChart.update();
                } else {
                    createChart(online.length, offline.length);
                }
            }
        }
        return;
    }
    $('#analysis-total').textContent = total;
    $('#analysis-online').textContent = online.length;
    $('#analysis-offline').textContent = offline.length;
    if (!analysisChart) {
        createChart(online.length, offline.length);
    } else {
        analysisChart.data.datasets[0].data = [online.length, offline.length];
        analysisChart.update();
    }
}
function createChart(online, offline) {
    analysisChart = new Chart($('#analysis-chart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Online', 'Offline'],
            datasets: [{
                data: [online, offline],
                backgroundColor: ['#18A999','#FF5E5E'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: "70%",
            plugins: { legend: { display: false } }
        }
    });
}
$('#analysis-sync-btn').onclick = function() {
    lastAnalysis = {online:[], offline:[]};
    updateAnalysis(true);
};
$('#analysis-total-btn').onclick = function() {
    filteredChannels = [];
    renderChannelList();
};
$('#analysis-online-btn').onclick = function() {
    if (lastAnalysis.online.length) {
        filteredChannels = lastAnalysis.online;
        renderChannelList(filteredChannels);
    }
};
$('#analysis-offline-btn').onclick = function() {
    if (lastAnalysis.offline.length) {
        filteredChannels = lastAnalysis.offline;
        renderChannelList(filteredChannels);
    }
};

// ---- Bugsfree Studio: Startup Animation Sequence and Random Cycles ----
function bfsLogoAnimCycle() {
    const bfs = document.querySelector('.special-animated');
    if (!bfs) return;
    bfs.classList.remove('bfs-glow-anim','bfs-pulse-anim','bfs-shine-anim','bfs-jump-anim');
    // Randomly pick one effect, weighted so 'bfs-glow-anim' is most frequent
    const effects = [
        ...Array(5).fill('bfs-glow-anim'),
        'bfs-pulse-anim','bfs-pulse-anim','bfs-shine-anim','bfs-jump-anim'
    ];
    const effect = effects[Math.floor(Math.random()*effects.length)];
    bfs.classList.add(effect);
    // If it's a one-off (pulse, shine, jump), remove after anim ends
    if (['bfs-pulse-anim','bfs-shine-anim','bfs-jump-anim'].includes(effect)) {
        const dur = effect==='bfs-pulse-anim'?700:effect==='bfs-jump-anim'?700:1400;
        setTimeout(() => {
            bfs.classList.remove(effect);
            bfs.classList.add('bfs-glow-anim');
        }, dur);
    }
}

function addBugsfreeStudioLogoAnimation() {
    const bfs = document.querySelector('.special-animated');
    if (!bfs) return;
    bfs.classList.add('bfs-intro-anim');
    setTimeout(() => {
        bfs.classList.remove('bfs-intro-anim');
        bfs.classList.add('bfs-glow-anim');
        setInterval(bfsLogoAnimCycle, 7000);
    }, 950);
}

// ---- Init ----
function initialize() {
    if (theme === 'light') document.body.classList.add('light');
    updateThemeIcon();
    loadChannelsFromStorage();
    renderChannelList();
    updateFavoritesListUI();
    updateHistoryListUI();
    updateTime();
    setInterval(updateTime, 1000);
    updateViewerCount();
    setInterval(updateViewerCount, 30000);
    setTimeout(()=>updateAnalysis(), 300);
    playChannel(0, playlistLoaded ? channels : demoPlaylist);
    feather.replace();
    $('#background-sync-status').textContent = backgroundSyncEnabled ? "ON" : "OFF";
    $('#scanlines-status').textContent = scanlinesEnabled ? 'ON' : 'OFF';
    $('.scanlines').style.display = scanlinesEnabled ? 'block' : 'none';
    document.body.style.overflowX = "hidden";
    $all('.left-panel, .channel-list, .history-list, .favorites-list, .channel-list-box').forEach(el => {
        if (el) el.style.overflowX = "hidden";
    });
    addBugsfreeStudioLogoAnimation();
}
window.addEventListener('storage', function(e) {
    if (e.key === playlistKey) {
        loadChannelsFromStorage();
        renderChannelList();
    }
});
window.addEventListener('DOMContentLoaded', initialize);
    </script>
	<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</body>
</html>